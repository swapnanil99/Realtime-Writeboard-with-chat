<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Simple Whiteboard + Chat + Undo/Redo</title>
<style>
  body, html {
    margin: 0; padding: 0;
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    height: 100%;
  }

  #main {
    display: flex;
    flex-direction: row;
    height: 100vh;
    padding: 10px;
    box-sizing: border-box;
  }

  #canvasContainer {
    flex: 3;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #controls {
    margin-bottom: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    justify-content: center;
  }

  canvas {
    border: 2px solid #222;
    border-radius: 8px;
    background: #fff;
    touch-action: none;
    width: 100%;
    max-width: 800px;
    height: 500px;
  }

  #chatContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-left: 12px;
    background: #fff;
    border: 2px solid #222;
    border-radius: 10px;
  }

  #chatMessages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .chatMessage {
    background: #e0e7ff;
    border-radius: 12px;
    margin-bottom: 5px;
    padding: 6px 10px;
    word-wrap: break-word;
  }

  #chatInputContainer {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ccc;
    background: #fff;
  }

  #chatInput {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  #sendChat {
    margin-left: 8px;
    padding: 8px 14px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  button {
    padding: 8px 12px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }

  button:hover {
    background: #0056b3;
  }

  input[type="color"],
  input[type="range"] {
    cursor: pointer;
  }

  @media (max-width:768px) {
    #main { flex-direction: column; }
    #chatContainer { margin-left: 0; margin-top: 10px; height: 40vh; }
  }
</style>
</head>
<body>

<div id="main">
  <div id="canvasContainer">
    <div id="controls">
      <input type="color" id="colorPicker" value="#000000">
      <input type="range" id="lineWidth" min="1" max="20" value="3">
      <button id="eraser">Eraser</button>
      <button id="undo">Undo</button>
      <button id="redo">Redo</button>
      <button id="clear">Clear</button>
      <button id="save">Save PNG</button>
    </div>
    <canvas id="board" width="800" height="500"></canvas>
  </div>

  <div id="chatContainer">
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="Type a message...">
      <button id="sendChat">Send</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const canvas = document.getElementById("board");
  const ctx = canvas.getContext("2d");

  let drawing = false;
  let color = "#000000";
  let lineWidth = 3;
  let undoStack = [];
  let redoStack = [];

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
      x: (clientX - rect.left) * (canvas.width / rect.width),
      y: (clientY - rect.top) * (canvas.height / rect.height)
    };
  }

  function startDraw(e) {
    drawing = true;
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y);
  }

  function draw(e) {
    if (!drawing) return;
    const pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.stroke();
  }

  function endDraw() {
    if (!drawing) return;
    drawing = false;
    ctx.closePath();
    saveState();
  }

  function saveState() {
    redoStack = [];
    undoStack.push(canvas.toDataURL());
    if (undoStack.length > 30) undoStack.shift();
  }

  function loadState(dataURL) {
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
    };
    img.src = dataURL;
  }

  // Mouse events
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);

  // Touch events
  canvas.addEventListener("touchstart", startDraw);
  canvas.addEventListener("touchmove", draw);
  canvas.addEventListener("touchend", endDraw);

  // Controls
  document.getElementById("colorPicker").oninput = e => color = e.target.value;
  document.getElementById("lineWidth").oninput = e => lineWidth = e.target.value;
  document.getElementById("eraser").onclick = () => color = "#ffffff";
  document.getElementById("clear").onclick = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    saveState();
  };

  document.getElementById("undo").onclick = () => {
    if (undoStack.length > 0) {
      redoStack.push(canvas.toDataURL());
      const last = undoStack.pop();
      loadState(last);
    }
  };

  document.getElementById("redo").onclick = () => {
    if (redoStack.length > 0) {
      undoStack.push(canvas.toDataURL());
      const next = redoStack.pop();
      loadState(next);
    }
  };

  document.getElementById("save").onclick = () => {
    const link = document.createElement("a");
    link.download = "whiteboard.png";
    link.href = canvas.toDataURL();
    link.click();
  };

  // Chat System (Local only)
  const chatInput = document.getElementById("chatInput");
  const chatMessages = document.getElementById("chatMessages");

  document.getElementById("sendChat").onclick = sendMessage;
  chatInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
  });

  function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;
    const div = document.createElement("div");
    div.className = "chatMessage";
    div.textContent = "You: " + msg;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatInput.value = "";
  }

  // Initial save state
  saveState();
});
</script>
</body>
</html>
