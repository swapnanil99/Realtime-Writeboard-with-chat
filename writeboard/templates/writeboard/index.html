<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Realtime Whiteboard + Chat</title>
<style>
  * { box-sizing: border-box; }
  body, html {
    margin: 0; padding: 0;
    font-family: 'Poppins', sans-serif;
    background: #eef2f7;
    height: 100%;
    overflow: hidden;
  }

  /* Modal */
  #modal {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex; justify-content: center; align-items: center;
    z-index: 10;
  }
  #modalContent {
    background: #fff;
    padding: 25px 20px;
    border-radius: 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.25);
    text-align: center;
    width: 90%; max-width: 360px;
  }
  #avatarSelection span {
    font-size: 32px; margin: 6px;
    cursor: pointer; border: 2px solid transparent;
    border-radius: 8px; padding: 5px;
    transition: transform 0.2s, border-color 0.2s;
  }
  #avatarSelection span:hover { transform: scale(1.2); }
  #avatarSelection span.selected { border-color: #007bff; }
  #usernameInput {
    margin-top: 10px;
    padding: 8px 10px;
    width: 80%;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
  }
  #enterRoom {
    background: #007bff; color: white;
    border: none; border-radius: 8px;
    padding: 10px 20px; margin-top: 15px;
    font-size: 16px; cursor: pointer;
    transition: background 0.2s;
  }
  #enterRoom:hover { background: #0056b3; }

  /* Main layout */
  #main {
    display: none;
    flex-direction: row;
    height: 100vh;
    padding: 8px;
    gap: 10px;
  }

  #canvasContainer {
    flex: 3;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  canvas {
    border: 2px solid #333;
    border-radius: 10px;
    background: #fff;
    width: 100%;
    max-width: 800px;
    height: auto;
    cursor: crosshair;
  }
  #controls {
    margin-bottom: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    background: #fff;
    padding: 8px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  #controls button {
    background: #007bff; color: white;
    border: none; border-radius: 8px;
    padding: 6px 12px; cursor: pointer;
    transition: background 0.2s;
  }
  #controls button:hover { background: #0056b3; }

  #chatContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fff;
    border: 2px solid #333;
    border-radius: 10px;
    overflow: hidden;
  }
  #chatMessages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f7f9fc;
  }
  .chatMessage {
    display: flex;
    align-items: center;
    background: #e0e7ff;
    border-radius: 12px;
    padding: 5px 10px;
    margin-bottom: 6px;
    word-wrap: break-word;
  }
  .chatMessage span.avatar {
    font-size: 22px;
    margin-right: 6px;
  }
  #chatInputContainer {
    display: flex;
    padding: 10px;
    background: #fff;
    border-top: 1px solid #ccc;
    position: sticky;
    bottom: 0;
  }
  #chatInput {
    flex: 1;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
  }
  #sendChat {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    margin-left: 6px;
    cursor: pointer;
  }
  #sendChat:hover { background: #0056b3; }

  /* Mobile styles */
  @media (max-width: 768px) {
    #main {
      flex-direction: column;
    }
    #chatContainer {
      height: 40vh;
      margin-top: 10px;
    }
    canvas {
      max-height: 50vh;
    }
  }
</style>
</head>
<body>

<!-- Login Modal -->
<div id="modal">
  <div id="modalContent">
    <h3>Select Avatar</h3>
    <div id="avatarSelection">
      <span data-avatar="ðŸ˜€">ðŸ˜€</span>
      <span data-avatar="ðŸ˜Ž">ðŸ˜Ž</span>
      <span data-avatar="ðŸ¥°">ðŸ¥°</span>
      <span data-avatar="ðŸ¤–">ðŸ¤–</span>
    </div>
    <input type="text" id="usernameInput" placeholder="Enter your name">
    <br>
    <button id="enterRoom">Enter Room</button>
  </div>
</div>

<!-- Main App -->
<div id="main">
  <div id="canvasContainer">
    <div id="controls">
      <label>Color:</label> <input type="color" id="colorPicker" value="#000000">
      <label>Width:</label> <input type="range" id="lineWidth" min="1" max="10" value="2">
      <button id="undo">Undo</button>
      <button id="redo">Redo</button>
      <button id="eraser">Eraser</button>
      <button id="clear">Clear</button>
      <button id="save">Save</button>
    </div>
    <canvas id="board" width="800" height="600"></canvas>
  </div>

  <div id="chatContainer">
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input type="text" id="chatInput" placeholder="Type a message">
      <button id="sendChat">Send</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  let drawing=false, current={}, color="#000", lineWidth=2;
  let username="", avatar="", selectedAvatar=null;
  const canvas=document.getElementById("board");
  const ctx=canvas.getContext("2d");
  const chatInput=document.getElementById("chatInput");
  const socket=new WebSocket((window.location.protocol==="https:"?"wss://":"ws://")+window.location.host+"/ws/whiteboard/");

  // Undo/Redo stacks
  const undoStack=[], redoStack=[];
  function saveState(){ undoStack.push(canvas.toDataURL()); redoStack.length=0; }

  socket.onmessage=(e)=>{
    const data=JSON.parse(e.data);
    if(data.type==="draw"){
      const w=canvas.width,h=canvas.height;
      drawLine(data.x0*w,data.y0*h,data.x1*w,data.y1*h,false,data.color,data.lineWidth);
    } else if(data.type==="chat"){
      const chat=document.getElementById("chatMessages");
      const div=document.createElement("div");
      div.className="chatMessage";
      div.innerHTML=`<span class="avatar">${data.avatar}</span> <b>${data.user}:</b> ${data.message}`;
      chat.appendChild(div);
      chat.scrollTop=chat.scrollHeight;
    }
  };

  function drawLine(x0,y0,x1,y1,emit,strokeColor=color,strokeWidth=lineWidth){
    ctx.beginPath();
    ctx.moveTo(x0,y0);
    ctx.lineTo(x1,y1);
    ctx.strokeStyle=strokeColor;
    ctx.lineWidth=strokeWidth;
    ctx.stroke();
    ctx.closePath();
    if(!emit) return;
    const w=canvas.width,h=canvas.height;
    socket.send(JSON.stringify({type:'draw', x0:x0/w, y0:y0/h, x1:x1/w, y1:y1/h, color:strokeColor, lineWidth:strokeWidth}));
  }

  // Mouse events
  canvas.addEventListener("mousedown", e=>{ drawing=true; current.x=e.offsetX; current.y=e.offsetY; saveState(); });
  canvas.addEventListener("mouseup", ()=>drawing=false);
  canvas.addEventListener("mousemove", e=>{
    if(!drawing) return;
    drawLine(current.x,current.y,e.offsetX,e.offsetY,true);
    current.x=e.offsetX; current.y=e.offsetY;
  });

  // Touch events
  canvas.addEventListener("touchstart", e=>{
    e.preventDefault();
    const touch=e.touches[0]; const rect=canvas.getBoundingClientRect();
    current.x=touch.clientX-rect.left; current.y=touch.clientY-rect.top; drawing=true; saveState();
  });
  canvas.addEventListener("touchmove", e=>{
    e.preventDefault();
    const touch=e.touches[0]; const rect=canvas.getBoundingClientRect();
    const x=touch.clientX-rect.left, y=touch.clientY-rect.top;
    drawLine(current.x,current.y,x,y,true);
    current.x=x; current.y=y;
  });
  canvas.addEventListener("touchend", ()=>drawing=false);

  // Controls
  document.getElementById("colorPicker").onchange=e=>color=e.target.value;
  document.getElementById("lineWidth").oninput=e=>lineWidth=e.target.value;
  document.getElementById("eraser").onclick=()=>color="#fff";
  document.getElementById("clear").onclick=()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    socket.send(JSON.stringify({type:'draw', x0:0,y0:0,x1:0,y1:0,color:'#fff',lineWidth:canvas.width}));
    saveState();
  };
  document.getElementById("save").onclick=()=>{
    const link=document.createElement("a");
    link.download="whiteboard.png";
    link.href=canvas.toDataURL();
    link.click();
  };
  document.getElementById("undo").onclick=()=>{
    if(undoStack.length>0){
      redoStack.push(canvas.toDataURL());
      const img=new Image(); img.src=undoStack.pop();
      img.onload=()=>{ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0);};
    }
  };
  document.getElementById("redo").onclick=()=>{
    if(redoStack.length>0){
      undoStack.push(canvas.toDataURL());
      const img=new Image(); img.src=redoStack.pop();
      img.onload=()=>{ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0);};
    }
  };

  // Chat
  document.getElementById("sendChat").onclick=sendMessage;
  chatInput.addEventListener("keypress", e=>{ if(e.key==="Enter") sendMessage(); });
  function sendMessage(){
    const msg=chatInput.value.trim();
    if(!msg) return;
    socket.send(JSON.stringify({type:'chat', user:username, message:msg, avatar:avatar}));
    chatInput.value="";
  }

  // Avatar selection
  document.querySelectorAll("#avatarSelection span").forEach(span=>{
    span.onclick=()=>{
      document.querySelectorAll("#avatarSelection span").forEach(i=>i.classList.remove("selected"));
      span.classList.add("selected");
      selectedAvatar=span.dataset.avatar;
    };
  });

  // Enter room
  document.getElementById("enterRoom").onclick=()=>{
    const uname=document.getElementById("usernameInput").value.trim();
    if(!uname || !selectedAvatar){alert("Select avatar & enter name!"); return;}
    username=uname; avatar=selectedAvatar;
    document.getElementById("modal").style.display="none";
    document.getElementById("main").style.display="flex";
  };
});
</script>
</body>
</html>
